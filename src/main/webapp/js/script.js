document.addEventListener("DOMContentLoaded", function () {
    console.log("Document ready, attaching event listener");

    // Êñ∞ËøáÊª§ÂäüËÉΩÂàùÂßãÂåñ
    const filterContainer = document.getElementById("filter-container");
    if (filterContainer) {
        filterContainer.addEventListener("click", function () {
            console.log("Filter button clicked");

            // ‚úÖ ‰ªÖÂú® `filterMenu` ‰∏∫Á©∫Êó∂Âä†ËΩΩËøáÊª§Âô®
            const filterMenu = document.getElementById("filterMenu");
            if (!filterMenu || filterMenu.innerHTML.trim() === "") {
                console.log("üîÑ Chargement des filtres...");
                loadFilters();
            }

            // ‚úÖ ÂàáÊç¢ËèúÂçïÊòæÁ§∫/ÈöêËóè
            toggleFilterMenu();
        });

    }

    console.log("Document ready, attaching event listener for Trier");

    const trierContainer = document.getElementById("trier-container");
    const sortAsc = document.getElementById("sortAsc");
    const sortDesc = document.getElementById("sortDesc");

    if (trierContainer) {
        trierContainer.addEventListener("click", function () {
            console.log("Trier button clicked");
            toggleTrierMenu();
        });
    }

    document.getElementById("sortAsc").addEventListener("click", function () {
        sortProduits("asc"); // ÂçáÂ∫èÊéíÂ∫è
    });

    document.getElementById("sortDesc").addEventListener("click", function () {
        sortProduits("desc"); // ÈôçÂ∫èÊéíÂ∫è
    });

    document.getElementById("promotion").addEventListener("click", togglePromotions);

    fetchProduits();


    // ‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÔºàÊï¥ÂêàÁÇπÂáª‰∫ã‰ª∂Ôºâ
    document.addEventListener('click', function(e) {
        // Â§ÑÁêÜË¥≠Áâ©ËΩ¶Êï∞ÈáèÊåâÈíÆ
        if (e.target.closest('.quantity-btn')) {
            const btn = e.target.closest('.quantity-btn');
            const productId = btn.dataset.productId;
            const delta = parseInt(btn.dataset.delta);
            updateQuantity(productId, delta);
        }

        // Â§ÑÁêÜ‰∫ßÂìÅÂàóË°®ÁöÑAddÊåâÈíÆ
        if (e.target.closest('.add-btn')) {
            const button = e.target.closest('.add-btn');
            const productId = button.dataset.productId;
            const quantity = parseInt(button.dataset.quantity || 1);
            addToCart(productId, quantity);
        }

        // Â§ÑÁêÜÊ∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶
        if (e.target.closest('#clearCart')) {
            clearCart();
        }
    });

});


// Ê∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶ÂáΩÊï∞ÔºàÂéüÊúâÔºâ
function clearCart() {
    if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫Ë¥≠Áâ©ËΩ¶ÂêóÔºü')) {
        fetch(`${window.location.origin}/ProjetDAI_war/annulerPanier`, {
            method: 'POST'
        }).then(() => window.location.reload())
            .catch(error => console.error('Error:', error));
    }
}

// Âä†ËΩΩÊâÄÊúâ RayonsÔºàÁÇπÂáª "Filtrer" ÊåâÈíÆÂêéË∞ÉÁî®Ôºâ
function loadFilters() {
    fetch(`${window.location.origin}/ProjetDAI_war/filtrer?action=listRayons`, {
        method: "GET",
        headers: { "Accept": "application/json" }
    })
        .then(response => response.json())
        .then(data => {
            console.log("‚úÖ Donn√©es re√ßues pour les rayons:", data);

            const filterMenu = document.getElementById("filterMenu");
            if (!filterMenu) {
                console.error("‚ùå ERREUR: filterMenu introuvable !");
                return;
            }

            // Ê∏ÖÁ©∫ËøáÊª§ËèúÂçï
            filterMenu.innerHTML = "<h3>Rayons</h3><ul id='rayonList'></ul>";

            const rayonList = document.getElementById("rayonList");

            if (Array.isArray(data.rayons) && data.rayons.length > 0) {
                data.rayons.forEach(rayon => {
                    let listItem = `<li><a href="#" class="rayon-link" data-rayon="${rayon}">${rayon}</a></li>`;
                    rayonList.innerHTML += listItem;
                });
            } else {
                filterMenu.innerHTML += "<label>Aucun rayon trouv√©</label>";
            }

            // ÁõëÂê¨ Rayon ÁÇπÂáª‰∫ã‰ª∂
            document.querySelectorAll(".rayon-link").forEach(link => {
                link.addEventListener("click", function (event) {
                    event.preventDefault(); // Èò≤Ê≠¢È°µÈù¢Ë∑≥ËΩ¨
                    let selectedRayon = this.getAttribute("data-rayon");
                    showCategories(selectedRayon);
                });
            });

            // ÊòæÁ§∫ËøáÊª§ËèúÂçï
            toggleFilterMenu(true);
        })
        .catch(error => console.error("‚ùå Erreur lors du chargement des rayons:", error));
}

// ÊòæÁ§∫ÈÄâÂÆö Rayon ÁöÑ CategoriesÔºåÊîØÊåÅÂ§ö‰∏™ Rayon ÂêåÊó∂Â±ïÂºÄ
function showCategories(rayon) {
    fetch(`${window.location.origin}/ProjetDAI_war/filtrer?action=listCategoriesByRayon&rayon=${encodeURIComponent(rayon)}`, {
        method: "GET",
        headers: { "Accept": "application/json" }
    })
        .then(response => response.json())
        .then(data => {
            console.log(`‚úÖ Cat√©gories pour Rayon "${rayon}":`, data);

            const rayonElement = document.querySelector(`.rayon-link[data-rayon="${rayon}"]`);
            if (!rayonElement) {
                console.error(`‚ùå Rayon introuvable: ${rayon}`);
                return;
            }

            let categorySectionId = `categories-${rayon.replace(/\s+/g, '-')}`;

            // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â±ïÂºÄ
            if (document.getElementById(categorySectionId)) {
                console.log(`‚ÑπÔ∏è Les cat√©gories pour "${rayon}" sont d√©j√† affich√©es.`);
                return;
            }

            // ÂàõÂª∫ Categories ÂÆπÂô®ÔºàÊó† h3 Ê†áÈ¢òÔºâ
            let categorySection = document.createElement("div");
            categorySection.id = categorySectionId;
            categorySection.style.marginLeft = "15px"; // ËÆ© categories Âíå Rayon ÊúâÈó¥Èöî

            if (Array.isArray(data.categories) && data.categories.length > 0) {
                data.categories.forEach(categorie => {
                    let categoryItem = document.createElement("div");
                    categoryItem.style.display = "flex";
                    categoryItem.style.alignItems = "center";

                    let checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.className = "filter-checkbox";
                    checkbox.value = categorie;
                    checkbox.id = `checkbox-${categorie.replace(/\s+/g, '-')}`;
                    checkbox.addEventListener("change", updateSelectedCategories);

                    let label = document.createElement("label");
                    label.innerText = categorie;
                    label.htmlFor = checkbox.id;  // ÁªëÂÆö label Âíå checkbox
                    label.style.marginLeft = "5px";

                    categoryItem.appendChild(checkbox);
                    categoryItem.appendChild(label);
                    categorySection.appendChild(categoryItem);
                });
            }
            else {
                categorySection.innerHTML = "<label>Aucune cat√©gorie trouv√©e</label>";
            }

            // Áõ¥Êé•ÊèíÂÖ•Âà∞ Rayon ‰∏ãÊñπ
            rayonElement.insertAdjacentElement("afterend", categorySection);

            // Á°Æ‰øù "Appliquer le Filtre" ÊåâÈíÆÂ≠òÂú®
            let filterMenu = document.getElementById("filterMenu");
            if (!document.getElementById("applyFilters")) {
                let applyButton = document.createElement("button");
                applyButton.id = "applyFilters";
                applyButton.innerText = "Appliquer le Filtre";
                applyButton.style.marginTop = "10px";
                applyButton.style.display = "block"; // Á°Æ‰øùÊòØÂùóÁ∫ßÂÖÉÁ¥†Ôºå‰∏ç‰ºöÈîô‰Ωç
                applyButton.style.padding = "8px 12px";
                applyButton.style.backgroundColor = "#ff9800"; // ÊåâÈíÆÈ¢úËâ≤
                applyButton.style.color = "white";
                applyButton.style.border = "none";
                applyButton.style.borderRadius = "5px";
                applyButton.style.cursor = "pointer";

                applyButton.addEventListener("click", applyFilters);

                filterMenu.appendChild(applyButton);
            }
        })
        .catch(error => console.error("‚ùå Erreur lors du chargement des cat√©gories:", error));
}

// Êõ¥Êñ∞ÈÄâ‰∏≠ÁöÑ Categories
function updateSelectedCategories() {
    let selected = new Set(JSON.parse(sessionStorage.getItem("selectedCategories") || "[]"));

    document.querySelectorAll(".filter-checkbox:checked").forEach(checkbox => {
        selected.add(checkbox.value);
    });

    sessionStorage.setItem("selectedCategories", JSON.stringify([...selected]));
    console.log("‚úÖ Cat√©gories s√©lectionn√©es mises √† jour:", [...selected]);
}

// ËøáÊª§‰∫ßÂìÅ
function applyFilters() {
    let selectedCategories = JSON.parse(sessionStorage.getItem("selectedCategories") || "[]");

    console.log("üîç Cat√©gories s√©lectionn√©es:", selectedCategories);

    if (selectedCategories.length === 0) {
        console.error("‚ùå Aucun filtre s√©lectionn√© !");
        return;
    }

    let params = new URLSearchParams();
    params.append("categories", selectedCategories.join(","));

    const url = `/ProjetDAI_war/filtrer?action=appliquerFiltre&${params.toString()}`;
    console.log("üîó URL de la requ√™te:", url);

    fetch(url, {
        method: "GET",
        headers: { "Accept": "application/json" }
    })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! Status: ${response.status}, Message: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log("üì¶ Produits filtr√©s:", data);

            const productList = document.getElementById("productList");
            productList.innerHTML = ""; // Ê∏ÖÁ©∫ÂéüÊù•ÁöÑ‰∫ßÂìÅÂàóË°®

            if (Array.isArray(data) && data.length > 0) {
                // ‚úÖ Â≠òÂÇ®Á≠õÈÄâÂêéÁöÑ‰∫ßÂìÅÊï∞ÊçÆ
                window.currentProduits = data;
                window.originalProduits = [...data]; // ‚úÖ Â§á‰ªΩÊï∞ÊçÆÔºå‰æõ‚ÄúAfficher les promos‚Äù ÊåâÈíÆ‰ΩøÁî®

                // ‚úÖ Áõ¥Êé•‰ΩøÁî® `renderProduits(produits);` ËøõË°åÊ∏≤ÊüìÔºå‰øùËØÅÊäòÊâ£ÊòæÁ§∫
                renderProduits(data);
            } else {
                productList.innerHTML = "<p>Aucun produit trouv√©</p>";
            }

            toggleFilterMenu(false);
        })
        .catch(error => {
            console.error("‚ùå Erreur lors du filtrage des produits:", error);
        });
}

// ÂàáÊç¢ËøáÊª§ËèúÂçïÁöÑÊòæÁ§∫Áä∂ÊÄÅ
function toggleFilterMenu() {
    const filterMenu = document.getElementById("filterMenu");
    if (!filterMenu) {
        console.error("‚ùå ERREUR: Element filterMenu introuvable !");
        return;
    }

    // ‚úÖ Â¶ÇÊûú `filterMenu` ÊòØ "block"ÔºåÂàôÈöêËóèÔºåÂê¶ÂàôÊòæÁ§∫
    if (filterMenu.style.display === "block") {
        filterMenu.style.display = "none";
    } else {
        filterMenu.style.display = "block";
    }
}




// ‰∫ßÂìÅËé∑ÂèñÂáΩÊï∞ÔºàÊï¥ÂêàÁâàÔºâ
function fetchProduits() {
    var xhr = new XMLHttpRequest();

    xhr.onload = function () {
        if (xhr.status === 200) {
            var elt = document.getElementById("productList");

            if (!elt) {
                console.warn("productListÂÖÉÁ¥†‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÊ∏≤Êüì");
                return;
            }

            var produits = JSON.parse(xhr.responseText);

            window.currentProduits = produits;
            window.originalProduits = [...produits]; // ‚úÖ Â§á‰ªΩÂéüÂßãÊï∞ÊçÆ

            renderProduits(produits);
        } else {
            console.error("Erreur lors de la r√©cup√©ration des produits. Statut :", xhr.status);
        }
    };

    xhr.open("GET", "/ProjetDAI_war/produits", true);
    xhr.setRequestHeader("Accept", "application/json");
    xhr.send();
}


// ËøáÊª§Áõ∏ÂÖ≥ÂáΩÊï∞ÔºàÊñ∞ÂäüËÉΩ‰øùÊåÅÂéüÊ†∑Ôºâ
function updateSessionStorage() {
    let selectedFilters = { categories: [], rayons: [] };

    var checkboxes = document.getElementsByClassName("filter-checkbox");
    for (var i = 0; i < checkboxes.length; i++) {
        if (checkboxes[i].checked) {
            var type = checkboxes[i].getAttribute("data-type");
            var value = checkboxes[i].value;
            selectedFilters[type + "s"].push(value); // "categories" Êàñ "rayons"
        }
    }

    sessionStorage.setItem("selectedFilters", JSON.stringify(selectedFilters));
}



// ‰∫ßÂìÅËØ¶ÊÉÖË∑≥ËΩ¨Â§ÑÁêÜÔºàÊñ∞ÂäüËÉΩÔºâ
document.getElementById("productList")?.addEventListener("click", function (e) {
    if (e.target.classList.contains("detail-link")) {
        e.preventDefault();
        sessionStorage.setItem("nomProduit", e.target.dataset.nom);
        window.location.href = "/ProjetDAI_war/jsp/article.jsp";
    }
});

document.querySelector(".product-container")?.addEventListener("click", function (e) {
    if (e.target.classList.contains("detail-link")) {
        e.preventDefault();
        sessionStorage.setItem("nomProduit", e.target.dataset.nom);

        // ‚úÖ Á°Æ‰øù URL ÁîüÊàêÊ≠£Á°Æ
        const basePath = window.location.origin + "/" + window.location.pathname.split('/')[1];
        window.location.href = basePath + "/jsp/article.jsp";
    }
});



// Êõ¥Êñ∞ÊÄª‰ª∑ÂáΩÊï∞ÔºàÂéüÊúâÔºâ
function updateTotalPrice() {
    let total = 0;
    document.querySelectorAll('tr[data-product-id]').forEach(row => {
        const price = parseFloat(row.dataset.price);
        const quantity = parseInt(row.querySelector('.quantity').innerText);
        total += price * quantity;
    });
    const totalElement = document.getElementById('total-price');
    if (totalElement) {
        totalElement.innerText = 'ÊÄª‰ª∑: ‚Ç¨' + total.toFixed(2);
    }
}



function updateQuantity(productId, delta) {
    const idp = `tr[data-product-id="${productId}"]`;
    const row = document.querySelector(idp);
    if (!row) {
        console.error('ÈîôËØØÔºöÊâæ‰∏çÂà∞ÂïÜÂìÅIDÂØπÂ∫îÁöÑË°å', productId);
        return;
    }

    const quantityElement = row.querySelector('.quantity');
    const unitPrice = parseFloat(row.dataset.price);
    const unitPriceApresPromotion = parseFloat(row.dataset.pricereduit);
    let newQuantity = parseInt(quantityElement.innerText) + delta;

    if (newQuantity < 1) newQuantity = 1;

    fetch(`${window.location.origin}/ProjetDAI_war/updateCart`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ productId: productId, quantity: newQuantity })
    }).then(response => {
        if (response.ok) {
            quantityElement.innerText = newQuantity;
            row.querySelector('#total-price-avant').innerText =
                '‚Ç¨' + (unitPrice * newQuantity).toFixed(2);
            row.querySelector('#total-price-apres').innerText =
                '‚Ç¨' + (unitPriceApresPromotion * newQuantity).toFixed(2);
            updateTotalPrice();
        }
    }).catch(error => console.error('ËØ∑Ê±ÇÂ§±Ë¥•:', error));
}




// Áªü‰∏ÄÁöÑaddToCartÂáΩÊï∞ÔºàÊï¥ÂêàÁâàÔºâ
function addToCart(productId, quantity = 1) {
    fetch(`${window.location.origin}/ProjetDAI_war/addToPanier`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ productId, quantity })
    }).then(response => {
        if (response.redirected) {
            window.location.href = response.url;
        } else if (response.ok) {
            updateCartCount(parseInt(document.getElementById("cartCount").innerText) + 1);
        }
    }).catch(error => console.error('Erreur:', error));
}




// ÂÖ®Â±ÄÂáΩÊï∞Â§ÑÁêÜÔºàÂéüÊúâÈúÄË¶Å‰øùÁïôÁöÑÂäüËÉΩÔºâ
function updateCartCount(count) {
    const cartCounter = document.getElementById("cartCount");
    if (cartCounter) cartCounter.innerText = count;
}

// ‰∫ßÂìÅÂ±ïÁ§∫ÂáΩÊï∞ÔºàÂÖºÂÆπÂ§ÑÁêÜÔºâ
function displayProducts(products, div) {
    div.innerHTML = products.map(p => `
        <button class="add-btn" 
            data-product-id="${p.id}"
            data-quantity="1">
            Add to Cart
        </button>
    `).join('');
}

function toggleTrierMenu() {
    const trierMenu = document.getElementById("trierMenu");
    if (!trierMenu) {
        console.error("‚ùå ERREUR: Element trierMenu introuvable !");
        return;
    }

    // ‚úÖ Á°Æ‰øù `display` Ê≠£Á°ÆÂàáÊç¢
    if (trierMenu.style.display === "none" || trierMenu.style.display === "") {
        trierMenu.style.display = "block";
    } else {
        trierMenu.style.display = "none";
    }
}


// ‚úÖ ÈáçÊñ∞Ê∏≤Êüì‰∫ßÂìÅÂà∞È°µÈù¢
// ‚úÖ ÈáçÊñ∞Ê∏≤Êüì‰∫ßÂìÅÂàóË°®ÔºåÂßãÁªàÊòæÁ§∫ÊäòÊâ£‰ø°ÊÅØ
function renderProduits(produits) {
    var elt = document.getElementById("productList");
    if (!elt) {
        console.warn("‚ùå ERREUR: `productList` ‰∏çÂ≠òÂú®");
        return;
    }

    elt.innerHTML = produits.map(produit => {
        // ‚úÖ ‰ªÖÂΩì promotion > 0 Êó∂ÊòæÁ§∫ÊäòÊâ£
        let promoBadge = produit.promotion > 0 ?
            `<div class="promotion-badge">-${(produit.promotion * 100).toFixed(0)}%</div>` : '';

        return `
            <div class="product-item">
                ${promoBadge}  
                <img src="${produit.imageUrl}" alt="${produit.nomProduit}" style="width: 150px; height: auto;"/>
                <h3>${produit.nomProduit}</h3>
                <p>Prix: ${produit.prixUnit}‚Ç¨</p>
                <a href="${window.location.origin}/ProjetDAI_war/jsp/article.jsp" class="detail-link" data-nom="${produit.nomProduit}">D√©tail du produit</a>
            </div>
        `;
    }).join('');
}


// ‚úÖ ‰ªÖÂâçÁ´ØÊéíÂ∫èÔºå‰∏çËØ∑Ê±ÇÊúçÂä°Âô®
function sortProduits(order) {
    if (!window.currentProduits || window.currentProduits.length === 0) {
        console.warn("‚ùå Aucun produit √† trier !");
        return;
    }

    let sortedProduits = [...window.currentProduits];
    if (order === "asc") {
        sortedProduits.sort((a, b) => a.prixUnit - b.prixUnit);
    } else if (order === "desc") {
        sortedProduits.sort((a, b) => b.prixUnit - a.prixUnit);
    }

    renderProduits(sortedProduits);
}

// ‚úÖ Âè™ÊòæÁ§∫ÊâìÊäòÂïÜÂìÅ
function togglePromotions() {
    let btn = document.getElementById("promotion");
    if (!btn) {
        console.error("‚ùå ERREUR: Bouton 'promotion' introuvable !");
        return;
    }

    // ‚úÖ Â¶ÇÊûúÂΩìÂâçÂ∑≤ÊòæÁ§∫‰øÉÈîÄÂïÜÂìÅÔºåÂàôÊÅ¢Â§çÊâÄÊúâÂïÜÂìÅ
    if (btn.dataset.filter === "on") {
        renderProduits(window.originalProduits);
        btn.innerText = "Afficher les promos";
        btn.dataset.filter = "off";
    } else {
        // ‚úÖ ËøáÊª§Âá∫ÊâìÊäòÂïÜÂìÅ
        let discountedProducts = window.originalProduits.filter(p => p.promotion > 0);
        renderProduits(discountedProducts);
        btn.innerText = "Afficher tous les produits";
        btn.dataset.filter = "on";
    }
}
